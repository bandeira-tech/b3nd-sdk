# B3nd Infrastructure — unified compose file
#
# Profiles:
#   test  — ephemeral DBs on non-standard ports (CI / integration tests)
#   dev   — persistent DBs on standard ports (local development)
#   rig   — web rig (:5555) + b3nd-node (:9942, memory backend)
#
# Usage:
#   make up p=test
#   make up p=dev
#   make up p=rig

services:
  # ── Test profile (ephemeral, non-standard ports) ──────────────────────

  postgres-test:
    image: postgres:17-alpine
    container_name: b3nd-postgres-test
    profiles: [test]
    environment:
      POSTGRES_DB: b3nd_test
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "55432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d b3nd_test"]
      interval: 5s
      timeout: 5s
      retries: 10

  mongo-test:
    image: mongo:8
    container_name: b3nd-mongo-test
    profiles: [test]
    ports:
      - "57017:27017"
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--eval", "db.adminCommand('ping')"]
      interval: 5s
      timeout: 5s
      retries: 10

  # ── Dev profile (persistent, standard ports) ──────────────────────────

  postgres-dev:
    image: postgres:17-alpine
    container_name: b3nd-postgres-dev
    profiles: [dev]
    environment:
      POSTGRES_DB: b3nd
      POSTGRES_USER: b3nd
      POSTGRES_PASSWORD: b3nd
    ports:
      - "5432:5432"
    volumes:
      - b3nd-pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U b3nd"]
      interval: 5s
      timeout: 5s
      retries: 5

  mongo-dev:
    image: mongo:8
    container_name: b3nd-mongo-dev
    profiles: [dev]
    ports:
      - "27017:27017"
    volumes:
      - b3nd-mongodata:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--eval", "db.adminCommand('ping')"]
      interval: 5s
      timeout: 5s
      retries: 5

  # ── Rig profile (frontend + local node) ────────────────────────────

  node:
    image: denoland/deno:2.5.6
    container_name: b3nd-node-local
    profiles: [rig]
    working_dir: /app/apps/b3nd-node
    volumes:
      - .:/app:cached
    ports:
      - "9942:9942"
    environment:
      BACKEND_URL: memory://
      SCHEMA_MODULE: ./example-schema.ts
      PORT: "9942"
      CORS_ORIGIN: "*"
    command: deno run -A mod.ts

  rig:
    image: node:22-alpine
    container_name: b3nd-rig
    profiles: [rig]
    working_dir: /app/apps/b3nd-web-rig
    volumes:
      - .:/app:cached
      - rig-node-modules:/app/apps/b3nd-web-rig/node_modules
    ports:
      - "5555:5555"
    command: sh -c "npm install && npx vite dev --port 5555 --host"
    depends_on:
      - node

volumes:
  b3nd-pgdata:
  b3nd-mongodata:
  rig-node-modules:
